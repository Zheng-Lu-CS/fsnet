# FSNet ä»£ç ç»“æ„é€Ÿé€šæŒ‡å—

## ğŸ—‚ï¸ ç›®å½•ç»“æ„ï¼ˆé‡è¦æ€§æ ‡æ³¨ï¼‰

```
fsnet/
â”œâ”€â”€ ğŸ“˜ myexp.py                    # â­â­â­ ä½ çš„å®éªŒå…¥å£
â”œâ”€â”€ ğŸ“˜ main.py                     # â­ å®˜æ–¹å…¥å£ï¼ˆå¯å¿½ç•¥ï¼‰
â”‚
â”œâ”€â”€ ğŸ“ exp/                        # â­â­â­ å®éªŒé€»è¾‘å±‚
â”‚   â”œâ”€â”€ exp_basic.py              # â­ åŸºç±»ï¼ˆé»‘ç›’ï¼‰
â”‚   â”œâ”€â”€ exp_fsnet.py              # â­â­â­ FSNetå®Œæ•´å®éªŒé€»è¾‘
â”‚   â”œâ”€â”€ exp_ogd.py                # â­â­ OGD baseline
â”‚   â”œâ”€â”€ exp_er.py                 # â­â­ Experience Replay
â”‚   â”œâ”€â”€ exp_nomem.py              # â­â­ æ— è®°å¿†æ¶ˆè
â”‚   â””â”€â”€ ...                       
â”‚
â”œâ”€â”€ ğŸ“ models/                    # â­â­â­ æ¨¡å‹å®šä¹‰å±‚
â”‚   â”œâ”€â”€ ts2vec/
â”‚   â”‚   â”œâ”€â”€ fsnet.py             # â­â­â­ TSEncoderä¸»æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ fsnet_.py            # â­â­â­â­â­ æ ¸å¿ƒï¼Adapter+Memory
â”‚   â”‚   â”œâ”€â”€ encoder.py           # â­ æ ‡å‡†TCNï¼ˆå¯é»‘ç›’ï¼‰
â”‚   â”‚   â”œâ”€â”€ dev.py               # â­ NoMemç‰ˆæœ¬
â”‚   â”‚   â””â”€â”€ losses.py            # â­ å¯¹æ¯”å­¦ä¹ lossï¼ˆå¯é»‘ç›’ï¼‰
â”‚
â”œâ”€â”€ ğŸ“ data/                      # â­ æ•°æ®åŠ è½½å±‚ï¼ˆé»‘ç›’ï¼‰
â”‚   â””â”€â”€ data_loader.py           
â”‚
â””â”€â”€ ğŸ“ utils/                     # â­ å·¥å…·å‡½æ•°ï¼ˆé»‘ç›’ï¼‰
    â”œâ”€â”€ metrics.py               # MAE, MSEè®¡ç®—
    â”œâ”€â”€ tools.py                 # Early stopping
    â””â”€â”€ timefeatures.py          # æ—¶é—´ç¼–ç 
```

---

## ğŸ”„ æ•°æ®æµå›¾ï¼ˆæ ¸å¿ƒç†è§£ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        myexp.py å…¥å£                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              exp_fsnet.py (å®éªŒé€»è¾‘)                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 1. _get_data() â†’ DataLoader                              â”‚  â”‚
â”‚  â”‚ 2. _build_model() â†’ net(args, device)                    â”‚  â”‚
â”‚  â”‚ 3. train()                                                â”‚  â”‚
â”‚  â”‚    â””â”€ for batch: _process_one_batch() â†’ loss.backward()  â”‚  â”‚
â”‚  â”‚ 4. test()                                                 â”‚  â”‚
â”‚  â”‚    â””â”€ for batch: _ol_one_batch() â†’ online update        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              models/ts2vec/fsnet.py (æ¨¡å‹ç»“æ„)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ TSEncoder:                                                â”‚  â”‚
â”‚  â”‚   input_fc â†’ DilatedConvEncoder â†’ repr_dropout â†’ output  â”‚  â”‚
â”‚  â”‚                      â†“                                    â”‚  â”‚
â”‚  â”‚              fsnet_.py æ ¸å¿ƒç»„ä»¶                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         models/ts2vec/fsnet_.py â­â­â­â­â­ æ ¸å¿ƒåˆ›æ–°ï¼           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ SamePadConv (å¸¦Adapterå’ŒMemoryçš„å·ç§¯å±‚):                  â”‚  â”‚
â”‚  â”‚                                                            â”‚  â”‚
â”‚  â”‚  1. å­˜å‚¨æ¢¯åº¦: store_grad()                                â”‚  â”‚
â”‚  â”‚     â””â”€ self.grads = Î³*old + (1-Î³)*new                    â”‚  â”‚
â”‚  â”‚                                                            â”‚  â”‚
â”‚  â”‚  2. è®¡ç®—æ ¡å‡†å‚æ•°: fw_chunks()                             â”‚  â”‚
â”‚  â”‚     â”œâ”€ grads â†’ controller â†’ [w, b, f]                    â”‚  â”‚
â”‚  â”‚     â”œâ”€ æ£€ç´¢è®°å¿†: q @ W â†’ top-k                           â”‚  â”‚
â”‚  â”‚     â””â”€ èåˆ: new = Ï„*adaptive + (1-Ï„)*memory            â”‚  â”‚
â”‚  â”‚                                                            â”‚  â”‚
â”‚  â”‚  3. åŠ¨æ€å·ç§¯: forward()                                   â”‚  â”‚
â”‚  â”‚     â””â”€ out = f * conv(x, weight*w, bias*b)              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” æ ¸å¿ƒä»£ç å®šä½ï¼ˆå¿…é¡»ç»†è¯»ï¼‰

### 1ï¸âƒ£ Adapteræœºåˆ¶ â­â­â­â­â­
**ä½ç½®**: `models/ts2vec/fsnet_.py` ç¬¬85-130è¡Œ

**åŠŸèƒ½**: æ ¹æ®æ¢¯åº¦å˜åŒ–åŠ¨æ€è°ƒæ•´å·ç§¯å‚æ•°

**å…³é”®ä»£ç **:
```python
def fw_chunks(self):
    # è¾“å…¥: self.grads (ç´¯ç§¯çš„æ¢¯åº¦ä¿¡æ¯)
    # è¾“å‡º: [w, b, f] ä¸‰ä¸ªæ ¡å‡†å‚æ•°
    
    x = self.grads.view(self.n_chunks, -1)
    rep = self.controller(x)           # MLPç¼–ç æ¢¯åº¦
    w = self.calib_w(rep)             # æƒé‡æ ¡å‡†
    b = self.calib_b(rep)             # åç½®æ ¡å‡†
    f = self.calib_f(rep)             # ç‰¹å¾æ ¡å‡†
```

### 2ï¸âƒ£ å…³è”è®°å¿† â­â­â­â­â­
**ä½ç½®**: `models/ts2vec/fsnet_.py` ç¬¬100-125è¡Œ

**åŠŸèƒ½**: æ£€ç´¢ç›¸ä¼¼å†å²æ¨¡å¼ï¼Œèåˆå†å²çŸ¥è¯†

**å…³é”®ä»£ç **:
```python
# è®°å¿†æ£€ç´¢
q = torch.cat([w, b, f])              # æŸ¥è¯¢å‘é‡
att = q @ self.W                       # æ³¨æ„åŠ›åˆ†æ•°
v, idx = torch.topk(att, 2)           # top-2æ£€ç´¢

# çŸ¥è¯†èåˆ
old_params = self.W[:, idx]
new_params = Ï„ * adaptive + (1-Ï„) * old_params
```

### 3ï¸âƒ£ åœ¨çº¿å­¦ä¹  â­â­â­â­
**ä½ç½®**: `exp/exp_fsnet.py` ç¬¬337-357è¡Œ

**åŠŸèƒ½**: æµ‹è¯•æ—¶å¿«é€Ÿé€‚åº”æ–°æ•°æ®

**å…³é”®ä»£ç **:
```python
def _ol_one_batch(self, ...):
    for _ in range(self.n_inner):    # å†…å¾ªç¯æ›´æ–°
        outputs = self.model(x)
        loss = criterion(outputs, true)
        loss.backward()
        self.opt.step()
        self.model.store_grad()      # å­˜å‚¨æ¢¯åº¦ä¾›Adapterä½¿ç”¨
```

---

## ğŸ”§ æ¥å£çº§ç†è§£ï¼ˆå¯é»‘ç›’ï¼‰

### æ•°æ®å±‚
```python
# data/data_loader.py
Dataset_ETT_hour(root_path, flag, size, ...)
# è¾“å…¥: CSVæ–‡ä»¶è·¯å¾„
# è¾“å‡º: (seq_x, seq_y, seq_x_mark, seq_y_mark)
```

### å·¥å…·å±‚
```python
# utils/metrics.py
metric(pred, true) â†’ (MAE, MSE, RMSE, MAPE, MSPE)

# utils/tools.py
EarlyStopping(patience) â†’ ç›‘æ§vali_lossè‡ªåŠ¨åœæ­¢

# utils/timefeatures.py  
time_features(dates, freq='h') â†’ 7ç»´æ—¶é—´ç¼–ç 
```

---

## ğŸ“Š å…³é”®è¶…å‚æ•°ï¼ˆå®éªŒæ—¶è°ƒæ•´ï¼‰

| å‚æ•° | ä½ç½® | ä½œç”¨ | å…¸å‹å€¼ |
|------|------|------|--------|
| `gamma` | fsnet_.py:66 | æ¢¯åº¦å¹³æ»‘ç³»æ•° | 0.9 |
| `tau` | fsnet_.py:67 | è®°å¿†èåˆæƒé‡ | 0.75 |
| `n_inner` | myexp.py:132 | åœ¨çº¿æ›´æ–°æ¬¡æ•° | 1 |
| `learning_rate` | myexp.py:104 | å­¦ä¹ ç‡ | 1e-4 |
| `hidden_dims` | fsnet.py:42 | TCNéšè—ç»´åº¦ | 64 |
| `depth` | fsnet.py:43 | TCNå±‚æ•° | 10 |

---

## ğŸ¯ æ¶ˆèå®éªŒå¯¹æ¯”çŸ©é˜µ

| æ–¹æ³• | å®ç°æ–‡ä»¶ | æ ¸å¿ƒå·®å¼‚ | é€‚ç”¨åœºæ™¯ |
|------|----------|----------|----------|
| **OGD** | exp_ogd.py | æ ‡å‡†åœ¨çº¿æ¢¯åº¦ä¸‹é™ | Baseline |
| **ER** | exp_er.py | ç»éªŒå›æ”¾buffer | å¯¹æ¯”å­¦ä¹  |
| **NoMem** | exp_nomem.py | åªæœ‰Adapterï¼Œæ— Memory | æ¶ˆèMemory |
| **FSNet** | exp_fsnet.py | Adapter + Memory | å®Œæ•´æ¨¡å‹ |

---

## ğŸ’¡ å¿«é€Ÿå®šä½æŠ€å·§

### æŸ¥æ‰¾æŸä¸ªåŠŸèƒ½
```bash
# æœç´¢å…³é”®è¯
grep -r "store_grad" fsnet/

# æŸ¥çœ‹å‡½æ•°è°ƒç”¨é“¾
# VSCode: F12 (è·³è½¬å®šä¹‰), Shift+F12 (æŸ¥æ‰¾å¼•ç”¨)
```

### ç†è§£æ•°æ®æµ
```python
# åœ¨å…³é”®ä½ç½®æ·»åŠ print
print(f"DEBUG: shape={x.shape}, device={x.device}")
```

---

## âš¡ é€Ÿé€šå»ºè®®

1. **å…ˆç”»å›¾åçœ‹ä»£ç ** - ç”¨ä¸Šé¢çš„æ•°æ®æµå›¾ç†è§£æ•´ä½“
2. **åªç»†è¯»æ ‡â­â­â­ä»¥ä¸Š** - å…¶ä»–å½“é»‘ç›’
3. **è·‘ä¸€éè°ƒè¯•** - åœ¨å…³é”®ä½ç½®æ‰“æ–­ç‚¹çœ‹shapeå˜åŒ–
4. **å¯¹æ¯”ä¸åŒæ–¹æ³•** - çœ‹exp_fsnet.py vs exp_ogd.pyçš„å·®å¼‚

---

## ğŸ”— æ ¸å¿ƒä»£ç é˜…è¯»é¡ºåº

```
1. myexp.py (å…¥å£) â†’ ç†è§£å®éªŒæµç¨‹
2. exp/exp_fsnet.py (å®éªŒé€»è¾‘) â†’ ç†è§£è®­ç»ƒ/æµ‹è¯•å¾ªç¯
3. models/ts2vec/fsnet.py (æ¨¡å‹ç»“æ„) â†’ ç†è§£æ•´ä½“æ¶æ„
4. models/ts2vec/fsnet_.py (æ ¸å¿ƒåˆ›æ–°) â†’ æ·±å…¥ç†è§£Adapter+Memory
```

**æ€»è€—æ—¶**: 30åˆ†é’Ÿï¼ˆå¿«é€Ÿæµè§ˆ + é‡ç‚¹ç²¾è¯»ï¼‰

---

é¢„è®¡å®Œæˆæ—¶é—´: 30åˆ†é’Ÿ âœ…
